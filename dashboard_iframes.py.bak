#!/usr/bin/env python3
"""
Iframe section routes for auto-updating dashboard components
"""
from flask import render_template_string
from datetime import datetime
import psycopg2
from psycopg2.extras import RealDictCursor

DB_CONFIG = {'database': 'postgres', 'user': 'rod'}

def get_db_connection():
    try:
        return psycopg2.connect(**DB_CONFIG, cursor_factory=RealDictCursor)
    except:
        return None

# Shared iframe styles
IFRAME_STYLES = """
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --gold: #d4af37; --bronze: #cd7f32; --parchment: #f4e8d0; --accent: #20c997; }
    body { 
        font-family: 'Crimson Text', serif; 
        background: linear-gradient(135deg, #1a0f0a, #2c1810);
        color: var(--parchment); 
        padding: 10px;
        max-height: 100vh;
        overflow-y: auto;
    }
    h2, h3, h4 { font-family: 'Cinzel', serif; color: var(--gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 15px 0; }
    .stat-box { 
        text-align: center; 
        padding: 12px; 
        background: linear-gradient(145deg, rgba(212, 175, 55, 0.1), rgba(205, 127, 50, 0.05));
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 6px;
    }
    .stat-value { font-size: 1.5em; color: var(--gold); font-family: 'Cinzel', serif; font-weight: 700; }
    .stat-label { font-size: 0.7em; color: rgba(244, 232, 208, 0.7); text-transform: uppercase; margin-top: 3px; }
    .machine-item { 
        padding: 12px; 
        margin: 8px 0; 
        background: linear-gradient(90deg, rgba(212, 175, 55, 0.12), rgba(205, 127, 50, 0.06)); 
        border-left: 4px solid var(--gold);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .machine-item:hover { 
        background: linear-gradient(90deg, rgba(212, 175, 55, 0.25), rgba(205, 127, 50, 0.15)); 
        transform: translateX(5px);
    }
    .machine-name { font-weight: 700; color: var(--gold); margin-bottom: 5px; font-size: 0.95em; }
    .machine-stats { display: flex; justify-content: space-between; font-size: 0.85em; color: rgba(244, 232, 208, 0.9); }
    .machine-detail { font-size: 0.75em; color: rgba(244, 232, 208, 0.7); margin-top: 3px; }
    a { color: var(--gold); text-decoration: none; border-bottom: 1px dotted var(--gold); }
    a:hover { color: #fff; border-color: #fff; }
    .trend-heating { color: #ff6b6b; }
    .trend-cooling { color: #4dabf7; }
    .trend-stable { color: #ffd43b; }
    .area-code { 
        display: inline-block;
        padding: 3px 10px;
        background: linear-gradient(135deg, var(--gold), var(--bronze));
        border-radius: 4px;
        font-family: 'Cinzel', serif;
        font-weight: 700;
        font-size: 0.9em;
        color: #1a0f0a;
        cursor: pointer;
    }
    .section-header { 
        border-bottom: 2px solid var(--gold); 
        padding-bottom: 8px; 
        margin-bottom: 15px;
        font-size: 1.2em;
    }
    .jackpot-feed-item {
        padding: 10px;
        margin: 6px 0;
        background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent);
        border-left: 3px solid var(--accent);
        border-radius: 3px;
    }
    .amount-large { color: #ff6b6b; font-weight: 700; }
    .amount-medium { color: var(--accent); font-weight: 600; }
    .amount-small { color: var(--parchment); }
</style>
"""

def register_iframe_routes(app):
    """Register all iframe section routes"""
    
    @app.route('/section/high-limit')
    def section_high_limit():
        """High Limit Room section - $10k+ jackpots"""
        conn = get_db_connection()
        if not conn:
            return "Database error", 500
        
        try:
            cur = conn.cursor()
            
            # High limit stats
            cur.execute("""
                SELECT 
                    COUNT(*) as count,
                    ROUND(AVG(amount), 2) as avg,
                    MAX(amount) as max
                FROM jackpots
                WHERE amount >= 10000
            """)
            stats = dict(cur.fetchone() or {'count': 0, 'avg': 0, 'max': 0})
            
            # Top high-limit machines (7-day recency)
            cur.execute("""
                SELECT 
                    machine_name,
                    denomination,
                    COUNT(*) as hit_count,
                    ROUND(AVG(amount), 2) as avg_payout,
                    MAX(amount) as max_payout,
                    COUNT(*) FILTER (WHERE hit_timestamp > NOW() - INTERVAL '7 days') as hits_7d
                FROM jackpots
                WHERE amount >= 10000 
                    AND machine_name NOT ILIKE '%Poker%' 
                    AND machine_name NOT ILIKE '%Keno%'
                GROUP BY machine_name, denomination
                HAVING COUNT(*) >= 2 
                    AND COUNT(*) FILTER (WHERE hit_timestamp > NOW() - INTERVAL '7 days') > 0
                ORDER BY hits_7d * AVG(amount) DESC
                LIMIT 5
            """)
            machines = [dict(row) for row in cur.fetchall()]
            
            cur.close()
            conn.close()
            
            
            template = """
            <!DOCTYPE html>
            <html>
            <head>
                <meta http-equiv="refresh" content="120">
                {styles}
            </head>
            <body>
                <h3 class="section-header">üëë HIGH LIMIT ROOM</h3>
                <p style="font-size: 0.8em; color: rgba(244, 232, 208, 0.7); margin-bottom: 15px;">Jackpots $10,000+</p>
                
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value">{count}</div>
                        <div class="stat-label">Total Hits</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${avg}</div>
                        <div class="stat-label">Avg Payout</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${max_val}</div>
                        <div class="stat-label">Max Hit</div>
                    </div>
                </div>
                
                <h4 style="font-size: 0.95em; margin: 20px 0 10px 0; color: var(--gold);">‚≠ê Hot High-Limit Machines (Last 7 Days)</h4>
                {{% for m in machines %}}
                <div class="machine-item" onclick="window.parent.location.href='/machine/{{{{ m.machine_name }}}}'">
                    <div class="machine-name">{{{{ m.machine_name[:35] }}}}</div>
                    <div class="machine-stats">
                        <span>{{{{ m.denomination }}}}</span>
                        <span style="color: var(--accent); font-weight: 700;">${{{{ "{:,.0f}".format(m.avg_payout) }}}}</span>
                    </div>
                    <div class="machine-detail">{{{{ m.hits_7d }}}} hits last week ‚Ä¢ Max: ${{{{ "{:,.0f}".format(m.max_payout) }}}}</div>
                </div>
                {{% endfor %}}
                
                <div style="text-align: center; margin-top: 15px; font-size: 0.75em; color: rgba(244, 232, 208, 0.5);">
                    Updates every 2 minutes
                </div>
            </body>
            </html>
            """.format(
                styles=IFRAME_STYLES,
                count="{:,}".format(stats['count']),
                avg="{:,.0f}".format(stats['avg']),
                max_val="{:,.0f}".format(stats['max'])
            )
            
            return render_template_string(template, machines=machines)
            
        except Exception as e:
            return f"Error: {e}", 500
    
    @app.route('/section/regular-floor')
    def section_regular_floor():
        """Regular Floor section - Under $10k jackpots"""
        conn = get_db_connection()
        if not conn:
            return "Database error", 500
        
        try:
            cur = conn.cursor()
            
            # Regular floor stats
            cur.execute("""
                SELECT 
                    COUNT(*) as count,
                    ROUND(AVG(amount), 2) as avg,
                    MAX(amount) as max
                FROM jackpots
                WHERE amount < 10000
                    AND machine_name NOT ILIKE '%Poker%'
                    AND machine_name NOT ILIKE '%Keno%'
            """)
            stats = dict(cur.fetchone() or {'count': 0, 'avg': 0, 'max': 0})
            
            # Top regular floor machines
            cur.execute("""
                SELECT 
                    machine_name,
                    denomination,
                    COUNT(*) as hit_count,
                    ROUND(AVG(amount), 2) as avg_payout,
                    MAX(amount) as max_payout,
                    COUNT(*) FILTER (WHERE hit_timestamp > NOW() - INTERVAL '7 days') as hits_7d
                FROM jackpots
                WHERE amount < 10000
                    AND machine_name NOT ILIKE '%Poker%'
                    AND machine_name NOT ILIKE '%Keno%'
                GROUP BY machine_name, denomination
                HAVING COUNT(*) >= 3
                    AND COUNT(*) FILTER (WHERE hit_timestamp > NOW() - INTERVAL '7 days') > 0
                ORDER BY hits_7d * AVG(amount) DESC
                LIMIT 5
            """)
            machines = [dict(row) for row in cur.fetchall()]
            
            # Area breakdown
            cur.execute("""
                SELECT
                    SUBSTRING(location_id, 1, 2) as area_code,
                    COUNT(*) as hit_count,
                    ROUND(AVG(amount), 2) as avg_payout,
                    COUNT(*) FILTER (WHERE hit_timestamp > NOW() - INTERVAL '24 hours') as hits_24h
                FROM jackpots
                WHERE amount < 10000
                    AND machine_name NOT ILIKE '%Poker%'
                    AND machine_name NOT ILIKE '%Keno%'
                GROUP BY area_code
                HAVING COUNT(*) >= 10
                ORDER BY hits_24h DESC, avg_payout DESC
                LIMIT 8
            """)
            areas = [dict(row) for row in cur.fetchall()]
            
            cur.close()
            conn.close()
            
            template = f"""
            <!DOCTYPE html>
            <html>
            <head>
                <meta http-equiv="refresh" content="120">
                {IFRAME_STYLES}
            </head>
            <body>
                <h3 class="section-header">üé∞ REGULAR FLOOR</h3>
                <p style="font-size: 0.8em; color: rgba(244, 232, 208, 0.7); margin-bottom: 15px;">Jackpots under $10,000</p>
                
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value">{{{{ "{:,}".format({stats['count']}) }}}}</div>
                        <div class="stat-label">Total Hits</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${{{{ "{:,.0f}".format({stats['avg']}) }}}}</div>
                        <div class="stat-label">Avg Payout</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${{{{ "{:,.0f}".format({stats['max']}) }}}}</div>
                        <div class="stat-label">Max Hit</div>
                    </div>
                </div>
                
                <h4 style="font-size: 0.95em; margin: 20px 0 10px 0; color: var(--gold);">‚≠ê Hot Machines (Last 7 Days)</h4>
                {{% for m in machines %}}
                <div class="machine-item" onclick="window.parent.location.href='/machine/{{{{ m.machine_name }}}}'">
                    <div class="machine-name">{{{{ m.machine_name[:35] }}}}</div>
                    <div class="machine-stats">
                        <span>{{{{ m.denomination }}}}</span>
                        <span style="color: var(--accent); font-weight: 700;">${{{{ "{:,.0f}".format(m.avg_payout) }}}}</span>
                    </div>
                    <div class="machine-detail">{{{{ m.hits_7d }}}} hits last week ‚Ä¢ Max: ${{{{ "{:,.0f}".format(m.max_payout) }}}}</div>
                </div>
                {{% endfor %}}
                
                <h4 style="font-size: 0.95em; margin: 25px 0 10px 0; color: var(--gold);">üìç Hot Areas (Last 24h)</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    {{% for area in areas %}}
                    <div class="area-code" onclick="window.parent.location.href='/area/{{{{ area.area_code }}}}'">
                        {{{{ area.area_code }}}} ‚Ä¢ {{{{ area.hits_24h }}}} hits ‚Ä¢ ${{{{ "{:,.0f}".format(area.avg_payout) }}}}
                    </div>
                    {{% endfor %}}
                </div>
                
                <div style="text-align: center; margin-top: 15px; font-size: 0.75em; color: rgba(244, 232, 208, 0.5);">
                    Updates every 2 minutes
                </div>
            </body>
            </html>
            """
            
            return render_template_string(template, machines=machines, areas=areas)
            
        except Exception as e:
            return f"Error: {e}", 500
    
    # Continue in next file due to length...
    return app
